<% if node.childless? %>
  <%= render('forms/odk/questioning', qing: node, grid_mode: grid_mode, label_row: nil, group: parent, xpath_prefix: xpath_prefix) unless node.hidden %>
<% else %>
  <% xpath = xpath_prefix %>
  <% if node.is_a?(QingGroup) %>
    <% xpath = "#{xpath_prefix}/#{node.odk_code}" %>
    <group>
    <%= content_tag(:label, node.group_name) %>
    <% if node.repeatable %>
      <% node_id_string = "#{xpath_prefix}/#{node.odk_code}" %>
      <repeat nodeset="<%= node_id_string %>">
    <% end #node.repeatable %>
  <% end # is qg open %>
  <% fragments = QingGroupOdkPartitioner.new.fragment(node) %>
  <% if fragments.present? %>
    <% fragments.each do |fragment| %>
      <%= render('forms/odk/form_controls_node', node: fragment, parent: nil, grid_mode: false, xpath_prefix: xpath) %>
    <% end %>
  <% else # no fragments %>
    <% if node.multilevel_fragment? %>
      <%= render('forms/odk/group_body', node: node, xpath: xpath) %>
    <% else %>
      <% appearance = node.has_group_child? ? nil : "field-list" %>
      <%= content_tag(:group, appearance: appearance) do %>
        <input ref="<%= "#{xpath}/#{node.try(:odk_code)}-header" %>">
          <hint ref="jr:itext('<%= node.try(:odk_code) %>-header:hint')"/>
        </input>
        <%= render('forms/odk/group_body', node: node, xpath: xpath) %>
      <% end %>
    <% end %>
  <% end #no fragments %>
  <% if node.is_a?(QingGroup) %>
    <% if node.repeatable %>
      </repeat>
    <% end #node repeatable %>
    </group>
  <% end #qg end %>
<% end #node childless %>
